{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.18.4.5664",
      "templateHash": "9741588038615780576"
    }
  },
  "parameters": {
    "deploymentParams": {
      "type": "object"
    },
    "identityParams": {
      "type": "object"
    },
    "storageAccountParams": {
      "type": "object"
    },
    "logAnalyticsWorkspaceParams": {
      "type": "object"
    },
    "dceParams": {
      "type": "object"
    },
    "brandTags": {
      "type": "object"
    },
    "vnetParams": {
      "type": "object"
    },
    "svc_bus_params": {
      "type": "object"
    },
    "funcParams": {
      "type": "object"
    },
    "acr_params": {
      "type": "object"
    },
    "container_instance_params": {
      "type": "object"
    },
    "cosmosDbParams": {
      "type": "object"
    },
    "dateNow": {
      "type": "string",
      "defaultValue": "[utcNow('yyyy-MM-dd-hh-mm')]"
    },
    "tags": {
      "type": "object",
      "defaultValue": "[union(parameters('brandTags'), createObject('last_deployed', parameters('dateNow')))]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "identityParams": {
            "value": "[parameters('identityParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "13956240806864188229"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-06-15",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "identityParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "_prebaked_uami_name_prefix": "[format('{0}_{1}_{2}', parameters('identityParams').namePrefix, parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').global_uniqueness)]"
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}_akane', variables('_prebaked_uami_name_prefix'))]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Create User-Assigned Managed Identity - For Everything"
              }
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}_vm', variables('_prebaked_uami_name_prefix'))]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Create User-Assigned Managed Identity - For VMs"
              }
            },
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[format('{0}_func', variables('_prebaked_uami_name_prefix'))]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "metadata": {
                "description": "Create User-Assigned Managed Identity - For Functions"
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "uami_name_akane": {
              "type": "string",
              "value": "[format('{0}_akane', variables('_prebaked_uami_name_prefix'))]"
            },
            "uami_name_vm": {
              "type": "string",
              "value": "[format('{0}_vm', variables('_prebaked_uami_name_prefix'))]"
            },
            "uami_name_func": {
              "type": "string",
              "value": "[format('{0}_func', variables('_prebaked_uami_name_prefix'))]"
            }
          }
        }
      },
      "metadata": {
        "description": "Create Identity"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_cosmos_db', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "cosmosDbParams": {
            "value": "[parameters('cosmosDbParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "939944078024847240"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-29",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "cosmosDbParams": {
              "type": "object"
            }
          },
          "variables": {
            "cosmos_db_accnt_name": "[replace(format('{0}-{1}-db-account-{2}', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness), '_', '-')]",
            "databaseName": "[format('{0}-db-{1}', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').global_uniqueness)]",
            "containerName": "[format('{0}-container-{1}', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').global_uniqueness)]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2022-08-15",
              "name": "[variables('cosmos_db_accnt_name')]",
              "location": "[parameters('deploymentParams').location]",
              "kind": "GlobalDocumentDB",
              "tags": "[parameters('tags')]",
              "properties": {
                "publicNetworkAccess": "Enabled",
                "databaseAccountOfferType": "Standard",
                "enableAutomaticFailover": true,
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "Session"
                },
                "locations": [
                  {
                    "locationName": "[parameters('deploymentParams').location]",
                    "isZoneRedundant": false
                  }
                ],
                "backupPolicy": {
                  "type": "Continuous"
                },
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2021-06-15",
              "name": "[format('{0}/{1}', variables('cosmos_db_accnt_name'), variables('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[variables('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', variables('cosmos_db_accnt_name'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2022-08-15",
              "name": "[format('{0}/{1}/{2}', variables('cosmos_db_accnt_name'), variables('databaseName'), variables('containerName'))]",
              "properties": {
                "resource": {
                  "id": "[variables('containerName')]",
                  "partitionKey": {
                    "paths": [
                      "/id"
                    ],
                    "kind": "Hash"
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/_etag/?"
                      }
                    ]
                  },
                  "conflictResolutionPolicy": {
                    "mode": "LastWriterWins",
                    "conflictResolutionPath": "/_ts"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', variables('cosmos_db_accnt_name'), variables('databaseName'))]"
              ]
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "cosmos_db_accnt_name": {
              "type": "string",
              "value": "[variables('cosmos_db_accnt_name')]"
            },
            "cosmos_db_name": {
              "type": "string",
              "value": "[variables('databaseName')]"
            },
            "cosmos_db_container_name": {
              "type": "string",
              "value": "[variables('containerName')]"
            }
          }
        }
      },
      "metadata": {
        "description": "Create Cosmos DB"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "logAnalyticsWorkspaceParams": {
            "value": "[parameters('logAnalyticsWorkspaceParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "16322971714955557294"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-21",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "logAnalyticsWorkspaceParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            }
          },
          "resources": [
            {
              "condition": "[equals(parameters('logAnalyticsWorkspaceParams').commitTier, false())]",
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": "[parameters('logAnalyticsWorkspaceParams').retentionInDays]",
                "sku": {
                  "name": "PerGB2018"
                },
                "workspaceCapping": {
                  "dailyQuotaGb": "[parameters('logAnalyticsWorkspaceParams').dailyQuotaGb]"
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            },
            {
              "condition": "[equals(parameters('logAnalyticsWorkspaceParams').commitTier, true())]",
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}-{1}-commitTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "CapacityReservation",
                  "capacityReservationLevel": 100
                }
              }
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness), format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').storeEventsCustomTableName, parameters('deploymentParams').global_uniqueness))]",
              "properties": {
                "plan": "Analytics",
                "retentionInDays": -1,
                "schema": {
                  "description": "Store order events custom table",
                  "displayName": "DOESNT-SEEM-TO-WORK-STORE-EVENTS-0",
                  "name": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').storeEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "RawData",
                      "type": "string"
                    },
                    {
                      "name": "request_id",
                      "type": "string"
                    },
                    {
                      "name": "event_type",
                      "type": "string"
                    },
                    {
                      "name": "store_id",
                      "displayName": "store_id",
                      "description": "The Id of the store placing the Order",
                      "type": "int"
                    },
                    {
                      "name": "cust_id",
                      "type": "int"
                    },
                    {
                      "name": "category",
                      "type": "string"
                    },
                    {
                      "name": "sku",
                      "type": "int"
                    },
                    {
                      "name": "price",
                      "type": "real"
                    },
                    {
                      "name": "qty",
                      "type": "int"
                    },
                    {
                      "name": "discount",
                      "type": "real"
                    },
                    {
                      "name": "gift_wrap",
                      "type": "boolean"
                    },
                    {
                      "name": "variant",
                      "description": "Product Variety",
                      "type": "string"
                    },
                    {
                      "name": "priority_shipping",
                      "description": "Priority Shipping requested",
                      "type": "boolean"
                    },
                    {
                      "name": "contact_me",
                      "description": "Miztiik Automation Brand Experience Store",
                      "displayName": "contact_me",
                      "type": "string"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness), format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').automationEventsCustomTableName, parameters('deploymentParams').global_uniqueness))]",
              "properties": {
                "plan": "Analytics",
                "retentionInDays": -1,
                "schema": {
                  "description": "Miztiik Automation Events",
                  "displayName": "DOESNT-SEEM-TO-WORK-AUTOMATION-EVENTS-1",
                  "name": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').automationEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "RawData",
                      "type": "string"
                    },
                    {
                      "name": "request_id",
                      "type": "string"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
              ]
            },
            {
              "type": "Microsoft.OperationalInsights/workspaces/tables",
              "apiVersion": "2022-10-01",
              "name": "[format('{0}/{1}', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness), format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').managedRunCmdCustomTableName, parameters('deploymentParams').global_uniqueness))]",
              "properties": {
                "plan": "Analytics",
                "retentionInDays": -1,
                "schema": {
                  "description": "Miztiik Run Command Automation Events",
                  "displayName": "DOESNT-SEEM-TO-WORK-AUTOMATION-EVENTS-2",
                  "name": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').managedRunCmdCustomTableName, parameters('deploymentParams').global_uniqueness)]",
                  "columns": [
                    {
                      "name": "TimeGenerated",
                      "type": "datetime"
                    },
                    {
                      "name": "RawData",
                      "type": "string"
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
              ]
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "logAnalyticsPayGWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            },
            "logAnalyticsPayGWorkspaceName": {
              "type": "string",
              "value": "[format('{0}-{1}-payGTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]"
            },
            "logAnalyticsCommitTierWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', format('{0}-{1}-commitTier-{2}', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            },
            "storeEventsCustomTableNamePrefix": {
              "type": "string",
              "value": "[format('{0}{1}', parameters('logAnalyticsWorkspaceParams').storeEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            },
            "storeEventsCustomTableName": {
              "type": "string",
              "value": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').storeEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            },
            "automationEventsCustomTableNamePrefix": {
              "type": "string",
              "value": "[format('{0}{1}', parameters('logAnalyticsWorkspaceParams').automationEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            },
            "automationEventsCustomTableName": {
              "type": "string",
              "value": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').automationEventsCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            },
            "managedRunCmdCustomTableNamePrefix": {
              "type": "string",
              "value": "[format('{0}{1}', parameters('logAnalyticsWorkspaceParams').managedRunCmdCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            },
            "managedRunCmdCustomTableName": {
              "type": "string",
              "value": "[format('{0}{1}_CL', parameters('logAnalyticsWorkspaceParams').managedRunCmdCustomTableName, parameters('deploymentParams').global_uniqueness)]"
            }
          }
        }
      },
      "metadata": {
        "description": "Create the Log Analytics Workspace"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "storageAccountParams": {
            "value": "[parameters('storageAccountParams')]"
          },
          "funcParams": {
            "value": "[parameters('funcParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "9831604754677873911"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-26",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "storageAccountParams": {
              "type": "object"
            },
            "funcParams": {
              "type": "object"
            },
            "tags": {
              "type": "object",
              "defaultValue": "[resourceGroup().tags]"
            }
          },
          "variables": {
            "uniqStr": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
            "saName": "[format('{0}{1}{2}{3}', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, variables('uniqStr'), parameters('deploymentParams').global_uniqueness)]",
            "uniqStr_1": "[substring(uniqueString(resourceGroup().id), 0, 6)]",
            "saName_1": "[format('{0}{1}{2}', parameters('funcParams').funcStorageAccountNamePrefix, variables('uniqStr_1'), parameters('deploymentParams').global_uniqueness)]"
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[variables('saName')]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[format('{0}', parameters('storageAccountParams').fault_tolerant_sku)]"
              },
              "kind": "[format('{0}', parameters('storageAccountParams').kind)]",
              "properties": {
                "minimumTlsVersion": "[format('{0}', parameters('storageAccountParams').minimumTlsVersion)]",
                "allowBlobPublicAccess": "[parameters('storageAccountParams').allowBlobPublicAccess]",
                "defaultToOAuthAuthentication": true,
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2022-05-01",
              "name": "[variables('saName_1')]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[format('{0}', parameters('storageAccountParams').fault_tolerant_sku)]"
              },
              "kind": "[format('{0}', parameters('storageAccountParams').kind)]",
              "properties": {
                "minimumTlsVersion": "[format('{0}', parameters('storageAccountParams').minimumTlsVersion)]",
                "allowBlobPublicAccess": "[parameters('storageAccountParams').allowBlobPublicAccess]",
                "defaultToOAuthAuthentication": true,
                "supportsHttpsTrafficOnly": true,
                "networkAcls": {
                  "bypass": "AzureServices",
                  "defaultAction": "Allow"
                },
                "encryption": {
                  "services": {
                    "file": {
                      "keyType": "Account",
                      "enabled": true
                    },
                    "blob": {
                      "keyType": "Account",
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "accessTier": "Hot"
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "saName": {
              "type": "string",
              "value": "[variables('saName')]"
            },
            "saPrimaryEndpointsBlob": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('saName')), '2022-05-01').primaryEndpoints.blob]"
            },
            "saPrimaryEndpoints": {
              "type": "object",
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', variables('saName')), '2022-05-01').primaryEndpoints]"
            },
            "saName_1": {
              "type": "string",
              "value": "[variables('saName_1')]"
            }
          }
        }
      },
      "metadata": {
        "description": "Create Storage Account"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_blob', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "storageAccountParams": {
            "value": "[parameters('storageAccountParams')]"
          },
          "storageAccountName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.saName.value]"
          },
          "storageAccountName_1": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.saName_1.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.logAnalyticsPayGWorkspaceId.value]"
          },
          "enableDiagnostics": {
            "value": false
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "15568782707485487793"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-23",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "storageAccountParams": {
              "type": "object"
            },
            "storageAccountName": {
              "type": "string"
            },
            "enableDiagnostics": {
              "type": "bool",
              "defaultValue": false
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            },
            "storageAccountName_1": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}/{1}/{2}', parameters('storageAccountName'), 'default', format('{0}-blob-{1}', parameters('storageAccountParams').blobNamePrefix, parameters('deploymentParams').global_uniqueness))]",
              "properties": {
                "publicAccess": "None"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageAccountName'), 'default')]"
              ]
            },
            {
              "condition": "[parameters('enableDiagnostics')]",
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', parameters('storageAccountName'))]",
              "name": "[format('{0}-Diaglogs', parameters('storageAccountName'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "category": "StorageWrite",
                    "enabled": true
                  }
                ],
                "metrics": [
                  {
                    "category": "Transaction",
                    "enabled": true
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2021-06-01",
              "name": "[format('{0}/{1}', parameters('storageAccountName_1'), 'default')]",
              "properties": {
                "cors": {
                  "corsRules": []
                }
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "blobContainerId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Storage/storageAccounts/blobServices/containers', parameters('storageAccountName'), 'default', format('{0}-blob-{1}', parameters('storageAccountParams').blobNamePrefix, parameters('deploymentParams').global_uniqueness))]"
            },
            "blobContainerName": {
              "type": "string",
              "value": "[format('{0}-blob-{1}', parameters('storageAccountParams').blobNamePrefix, parameters('deploymentParams').global_uniqueness)]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
      ],
      "metadata": {
        "description": "Create Storage Account - Blob container"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_Svc_Bus', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "svc_bus_params": {
            "value": "[parameters('svc_bus_params')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "12676617366686563080"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-19",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "svc_bus_params": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            }
          },
          "variables": {
            "svc_bus_name": "[replace(format('{0}-{1}-svc-bus-ns-{2}-{3}', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').global_uniqueness), '_', '-')]"
          },
          "resources": [
            {
              "type": "Microsoft.ServiceBus/namespaces",
              "apiVersion": "2022-01-01-preview",
              "name": "[variables('svc_bus_name')]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {}
            },
            {
              "type": "Microsoft.ServiceBus/namespaces/queues",
              "apiVersion": "2022-01-01-preview",
              "name": "[format('{0}/{1}', variables('svc_bus_name'), format('{0}-q-{1}', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness))]",
              "properties": {
                "lockDuration": "PT5M",
                "maxSizeInMegabytes": 1024,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "deadLetteringOnMessageExpiration": false,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 5,
                "enablePartitioning": false,
                "enableExpress": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('svc_bus_name'))]"
              ]
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "svc_bus_ns_name": {
              "type": "string",
              "value": "[variables('svc_bus_name')]"
            },
            "svc_bus_q_name": {
              "type": "string",
              "value": "[format('{0}-q-{1}', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness)]"
            }
          }
        }
      },
      "metadata": {
        "description": "Create the Service Bus & Queue"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_Dce', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "dceParams": {
            "value": "[parameters('dceParams')]"
          },
          "osKind": {
            "value": "linux"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "1346156020854514577"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-19",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "dceParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "osKind": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionEndpoints",
              "apiVersion": "2021-04-01",
              "name": "[format('{0}-{1}-Dce-{2}', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('osKind')]",
              "properties": {
                "networkAcls": {
                  "publicNetworkAccess": "Enabled"
                }
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "linDataCollectionEndpointId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/dataCollectionEndpoints', format('{0}-{1}-Dce-{2}', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            },
            "linDataCollectionEndpointName": {
              "type": "string",
              "value": "[format('{0}-{1}-Dce-{2}', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_Dcr', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "osKind": {
            "value": "Linux"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "storeEventsRuleName": {
            "value": "storeEvents_Dcr"
          },
          "storeEventsLogFilePattern": {
            "value": "/var/log/miztiik*.json"
          },
          "storeEventscustomTableNamePrefix": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.storeEventsCustomTableNamePrefix.value]"
          },
          "automationEventsRuleName": {
            "value": "miztiikAutomation_Dcr"
          },
          "automationEventsLogFilePattern": {
            "value": "/var/log/miztiik-automation-*.log"
          },
          "automationEventsCustomTableNamePrefix": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.automationEventsCustomTableNamePrefix.value]"
          },
          "managedRunCmdRuleName": {
            "value": "miztiikManagedRunCmd_Dcr"
          },
          "managedRunCmdLogFilePattern": {
            "value": "/var/log/azure/run-command-handler/*.log"
          },
          "managedRunCmdCustomTableNamePrefix": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.managedRunCmdCustomTableNamePrefix.value]"
          },
          "linDataCollectionEndpointId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_Dce', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.linDataCollectionEndpointId.value]"
          },
          "logAnalyticsPayGWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.logAnalyticsPayGWorkspaceName.value]"
          },
          "logAnalyticsPayGWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.logAnalyticsPayGWorkspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "3989949129920889014"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-05-19",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "osKind": {
              "type": "string"
            },
            "storeEventsRuleName": {
              "type": "string"
            },
            "storeEventsLogFilePattern": {
              "type": "string"
            },
            "storeEventscustomTableNamePrefix": {
              "type": "string"
            },
            "automationEventsRuleName": {
              "type": "string"
            },
            "automationEventsLogFilePattern": {
              "type": "string"
            },
            "automationEventsCustomTableNamePrefix": {
              "type": "string"
            },
            "managedRunCmdRuleName": {
              "type": "string"
            },
            "managedRunCmdLogFilePattern": {
              "type": "string"
            },
            "managedRunCmdCustomTableNamePrefix": {
              "type": "string"
            },
            "linDataCollectionEndpointId": {
              "type": "string"
            },
            "logAnalyticsPayGWorkspaceId": {
              "type": "string"
            },
            "logAnalyticsPayGWorkspaceName": {
              "type": "string"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2021-09-01-preview",
              "name": "[format('{0}_{1}_{2}', parameters('storeEventsRuleName'), parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('osKind')]",
              "properties": {
                "description": "Log collection rule for miztiik web store data across all linux Vms.",
                "dataCollectionEndpointId": "[parameters('linDataCollectionEndpointId')]",
                "streamDeclarations": {
                  "[format('Custom-{0}_CL', parameters('storeEventscustomTableNamePrefix'))]": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "RawData",
                        "type": "string"
                      },
                      {
                        "name": "request_id",
                        "type": "string"
                      },
                      {
                        "name": "event_type",
                        "type": "string"
                      },
                      {
                        "name": "store_id",
                        "type": "int"
                      },
                      {
                        "name": "cust_id",
                        "type": "int"
                      },
                      {
                        "name": "category",
                        "type": "string"
                      },
                      {
                        "name": "sku",
                        "type": "int"
                      },
                      {
                        "name": "price",
                        "type": "real"
                      },
                      {
                        "name": "qty",
                        "type": "int"
                      },
                      {
                        "name": "discount",
                        "type": "real"
                      },
                      {
                        "name": "gift_wrap",
                        "type": "boolean"
                      },
                      {
                        "name": "variant",
                        "type": "string"
                      },
                      {
                        "name": "priority_shipping",
                        "type": "boolean"
                      },
                      {
                        "name": "contact_me",
                        "type": "string"
                      }
                    ]
                  }
                },
                "dataSources": {
                  "logFiles": [
                    {
                      "streams": [
                        "[format('Custom-{0}_CL', parameters('storeEventscustomTableNamePrefix'))]"
                      ],
                      "filePatterns": [
                        "[parameters('storeEventsLogFilePattern')]"
                      ],
                      "format": "text",
                      "settings": {
                        "text": {
                          "recordStartTimestampFormat": "ISO 8601"
                        }
                      },
                      "name": "myFancyLogFileFormat"
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "name": "[parameters('logAnalyticsPayGWorkspaceName')]",
                      "workspaceResourceId": "[parameters('logAnalyticsPayGWorkspaceId')]"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "[format('Custom-{0}_CL', parameters('storeEventscustomTableNamePrefix'))]"
                    ],
                    "destinations": [
                      "[parameters('logAnalyticsPayGWorkspaceName')]"
                    ],
                    "transformKql": "source | extend jsonContext = parse_json(tostring(RawData)) | extend TimeGenerated=now(), RawData=tostring(RawData), request_id=tostring(jsonContext.request_id) , event_type=tostring(jsonContext.event_type), store_id=toint(jsonContext.store_id),cust_id=toint(jsonContext.cust_id),category=tostring(jsonContext.category),sku=toint(jsonContext.sku),price=toreal(jsonContext.price),qty=toint(jsonContext.qty),discount=toreal(jsonContext.discount),gift_wrap=tobool(jsonContext.gift_wrap),variant=tostring(jsonContext.variant),priority_shipping=tobool(jsonContext.priority_shipping),contact_me=tostring(jsonContext.contact_me)",
                    "outputStream": "[format('Custom-{0}_CL', parameters('storeEventscustomTableNamePrefix'))]"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2021-09-01-preview",
              "name": "[format('{0}_{1}_{2}', parameters('automationEventsRuleName'), parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('osKind')]",
              "properties": {
                "description": "Log collection rule for miztiik automation events across all linux Vms.",
                "dataCollectionEndpointId": "[parameters('linDataCollectionEndpointId')]",
                "streamDeclarations": {
                  "[format('Custom-{0}_CL', parameters('automationEventsCustomTableNamePrefix'))]": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "RawData",
                        "type": "string"
                      },
                      {
                        "name": "request_id",
                        "type": "string"
                      }
                    ]
                  }
                },
                "dataSources": {
                  "logFiles": [
                    {
                      "streams": [
                        "[format('Custom-{0}_CL', parameters('automationEventsCustomTableNamePrefix'))]"
                      ],
                      "filePatterns": [
                        "[parameters('automationEventsLogFilePattern')]"
                      ],
                      "format": "text",
                      "settings": {
                        "text": {
                          "recordStartTimestampFormat": "ISO 8601"
                        }
                      },
                      "name": "myFancyLogFileFormat"
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "name": "[parameters('logAnalyticsPayGWorkspaceName')]",
                      "workspaceResourceId": "[parameters('logAnalyticsPayGWorkspaceId')]"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "[format('Custom-{0}_CL', parameters('automationEventsCustomTableNamePrefix'))]"
                    ],
                    "destinations": [
                      "[parameters('logAnalyticsPayGWorkspaceName')]"
                    ],
                    "transformKql": "source | extend TimeGenerated=now(), RawData=tostring(RawData)",
                    "outputStream": "[format('Custom-{0}_CL', parameters('automationEventsCustomTableNamePrefix'))]"
                  }
                ]
              }
            },
            {
              "type": "Microsoft.Insights/dataCollectionRules",
              "apiVersion": "2021-09-01-preview",
              "name": "[format('{0}_{1}_{2}', parameters('managedRunCmdRuleName'), parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('osKind')]",
              "properties": {
                "description": "Log collection rule Managed Run Command executions across all linux Vms. https://learn.microsoft.com/en-us/azure/virtual-machines/linux/run-command#action-run-command-linux-troubleshooting",
                "dataCollectionEndpointId": "[parameters('linDataCollectionEndpointId')]",
                "streamDeclarations": {
                  "[format('Custom-{0}_CL', parameters('managedRunCmdCustomTableNamePrefix'))]": {
                    "columns": [
                      {
                        "name": "TimeGenerated",
                        "type": "datetime"
                      },
                      {
                        "name": "RawData",
                        "type": "string"
                      }
                    ]
                  }
                },
                "dataSources": {
                  "logFiles": [
                    {
                      "streams": [
                        "[format('Custom-{0}_CL', parameters('managedRunCmdCustomTableNamePrefix'))]"
                      ],
                      "filePatterns": [
                        "[parameters('managedRunCmdLogFilePattern')]"
                      ],
                      "format": "text",
                      "settings": {
                        "text": {
                          "recordStartTimestampFormat": "ISO 8601"
                        }
                      },
                      "name": "myFancyLogFileFormat"
                    }
                  ]
                },
                "destinations": {
                  "logAnalytics": [
                    {
                      "name": "[parameters('logAnalyticsPayGWorkspaceName')]",
                      "workspaceResourceId": "[parameters('logAnalyticsPayGWorkspaceId')]"
                    }
                  ]
                },
                "dataFlows": [
                  {
                    "streams": [
                      "[format('Custom-{0}_CL', parameters('managedRunCmdCustomTableNamePrefix'))]"
                    ],
                    "destinations": [
                      "[parameters('logAnalyticsPayGWorkspaceName')]"
                    ],
                    "transformKql": "source | extend TimeGenerated=now(), RawData=tostring(RawData)",
                    "outputStream": "[format('Custom-{0}_CL', parameters('managedRunCmdCustomTableNamePrefix'))]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "storeEventsDcrId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}_{1}_{2}', parameters('storeEventsRuleName'), parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            },
            "automationEventsDcrId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Insights/dataCollectionRules', format('{0}_{1}_{2}', parameters('automationEventsRuleName'), parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_Dce', parameters('dceParams').endpointNamePrefix, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_Vnet', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "vnetParams": {
            "value": "[parameters('vnetParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "5172761532526636941"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-06-04",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "vnetParams": {
              "type": "object"
            },
            "tags": {
              "type": "object",
              "defaultValue": "[resourceGroup().tags]"
            },
            "vnetAddPrefixes": {
              "type": "object",
              "defaultValue": {
                "addressPrefixes": [
                  "10.0.0.0/16"
                ]
              }
            },
            "webSubnet01Cidr": {
              "type": "string",
              "defaultValue": "10.0.0.0/24"
            },
            "webSubnet02Cidr": {
              "type": "string",
              "defaultValue": "10.0.1.0/24"
            },
            "appSubnet01Cidr": {
              "type": "string",
              "defaultValue": "10.0.2.0/24"
            },
            "appSubnet02Cidr": {
              "type": "string",
              "defaultValue": "10.0.3.0/24"
            },
            "dbSubnet01Cidr": {
              "type": "string",
              "defaultValue": "10.0.4.0/24"
            },
            "dbSubnet02Cidr": {
              "type": "string",
              "defaultValue": "10.0.5.0/24"
            }
          },
          "resources": [
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-05-01",
              "name": "[format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "properties": {
                "addressSpace": "[parameters('vnetAddPrefixes')]",
                "subnets": [
                  {
                    "name": "webSubnet01",
                    "properties": {
                      "addressPrefix": "[parameters('webSubnet01Cidr')]"
                    }
                  },
                  {
                    "name": "webSubnet02",
                    "properties": {
                      "addressPrefix": "[parameters('webSubnet02Cidr')]"
                    }
                  },
                  {
                    "name": "appSubnet01",
                    "properties": {
                      "addressPrefix": "[parameters('appSubnet01Cidr')]"
                    }
                  },
                  {
                    "name": "appSubnet02",
                    "properties": {
                      "addressPrefix": "[parameters('appSubnet02Cidr')]"
                    }
                  },
                  {
                    "name": "dbSubnet01",
                    "properties": {
                      "addressPrefix": "[parameters('dbSubnet01Cidr')]"
                    }
                  },
                  {
                    "name": "dbSubnet02",
                    "properties": {
                      "addressPrefix": "[parameters('dbSubnet02Cidr')]"
                    }
                  }
                ]
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "vnetId": {
              "type": "string",
              "value": "[resourceId('Microsoft.Network/virtualNetworks', format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
            },
            "vnetName": {
              "type": "string",
              "value": "[format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]"
            },
            "vnetSubnets": {
              "type": "array",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2021-05-01').subnets]"
            },
            "dbSubnet01Id": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2021-05-01').subnets[4].id]"
            },
            "dbSubnet02Id": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.Network/virtualNetworks', format('{0}_{1}_vnet_{2}', parameters('vnetParams').vnetNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2021-05-01').subnets[5].id]"
            }
          }
        }
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('perms_provider_to_uami_{0}', parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "uami_name_akane": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.uami_name_akane.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "14652867890985102688"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-06-15",
                "owner": "miztiik@github"
              }
            },
            "uami_name_akane": {
              "type": "string"
            }
          },
          "variables": {
            "builtInRoleNames": [
              {
                "name": "Owner",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]"
              },
              {
                "name": "Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]"
              },
              {
                "name": "Reader",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'acdd72a7-3385-48ef-bd42-f606fba81ae7')]"
              },
              {
                "name": "Storage Blob Data Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]"
              },
              {
                "name": "Azure Service Bus Data Owner",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '090c5cfd-751d-490a-894a-3ce6f1109419')]"
              },
              {
                "name": "Azure Sentinel Automation Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'f4c81013-99ee-4d62-a7ee-b3f1f648599a')]"
              },
              {
                "name": "Log Analytics Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]"
              },
              {
                "name": "Data Factory Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '673868aa-7521-48a0-acc6-0f60742d39f5')]"
              },
              {
                "name": "Logic App Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '87a39d53-fc1b-424a-814c-f7e04687dc9e')]"
              },
              {
                "name": "Logic App Operator",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '515c2055-d9d4-4321-b1b9-bd0c9a0f79fe')]"
              },
              {
                "name": "Managed Application Contributor Role",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '641177b8-a67a-45b9-a033-47bc880bb21e')]"
              },
              {
                "name": "Managed Application Operator Role",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c7393b34-138c-406f-901b-d8cf2b17e6ae')]"
              },
              {
                "name": "Managed Applications Reader",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b9331d33-8a36-4f8c-b097-4f54124fdb44')]"
              },
              {
                "name": "Monitoring Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '749f88d5-cbae-40b8-bcfc-e573ddc772fa')]"
              },
              {
                "name": "Monitoring Metrics Publisher",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]"
              },
              {
                "name": "Monitoring Reader",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '43d0d8ad-25c7-4714-9337-8ba259a9fe05')]"
              },
              {
                "name": "Resource Policy Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '36243c78-bf99-498c-9df9-86d9f8d28608')]"
              },
              {
                "name": "User Access Administrator",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
              },
              {
                "name": "Search Index Data Contributor",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8ebe5a00-799e-43f5-93ac-243d3dce84a7')]"
              },
              {
                "name": "AcrDelete",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'c2f4ef07-c644-48eb-af81-4b1b4947fb11')]"
              },
              {
                "name": "AcrImageSigner",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '6cef56e8-d556-48e5-a04f-b8e64114680f')]"
              },
              {
                "name": "AcrPull",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]"
              },
              {
                "name": "AcrPush",
                "id": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8311e382-0749-4cb8-b61a-304f252e45ec')]"
              }
            ]
          },
          "resources": [
            {
              "copy": {
                "name": "roleAssignment",
                "count": "[length(variables('builtInRoleNames'))]"
              },
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2020-04-01-preview",
              "name": "[guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), resourceGroup().id, variables('builtInRoleNames')[copyIndex()].name)]",
              "properties": {
                "roleDefinitionId": "[variables('builtInRoleNames')[copyIndex()].id]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), '2023-01-31').principalId]"
              },
              "metadata": {
                "description": "Assign the Permissions to Role"
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
      ],
      "metadata": {
        "description": "Add Permissions to UAMI"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_container_registry', parameters('container_instance_params').name_prefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "acr_params": {
            "value": "[parameters('acr_params')]"
          },
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uami_name_akane": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.uami_name_akane.value]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.logAnalyticsPayGWorkspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "4783147622650209140"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-06-25",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "acr_params": {
              "type": "object"
            },
            "uami_name_akane": {
              "type": "string"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string"
            }
          },
          "variables": {
            "_acr_name": "[replace(replace(format('{0}-{1}', parameters('acr_params').name_prefix, parameters('deploymentParams').global_uniqueness), '_', ''), '-', '')]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-01-01-preview",
              "name": "[variables('_acr_name')]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "Premium"
              },
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')))]": {}
                }
              },
              "properties": {
                "adminUserEnabled": true,
                "anonymousPullEnabled": true,
                "publicNetworkAccess": "Enabled",
                "zoneRedundancy": "Enabled",
                "networkRuleBypassOptions": "AzureServices"
              }
            },
            {
              "type": "Microsoft.Insights/diagnosticSettings",
              "apiVersion": "2021-05-01-preview",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', variables('_acr_name'))]",
              "name": "[format('{0}-diag', variables('_acr_name'))]",
              "properties": {
                "workspaceId": "[parameters('logAnalyticsWorkspaceId')]",
                "logs": [
                  {
                    "categoryGroup": "allLogs",
                    "enabled": true,
                    "retentionPolicy": {
                      "days": 90,
                      "enabled": true
                    }
                  }
                ],
                "metrics": [
                  {
                    "category": "AllMetrics",
                    "timeGrain": "PT5M",
                    "enabled": true,
                    "retentionPolicy": {
                      "enabled": false,
                      "days": 0
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.ContainerRegistry/registries', variables('_acr_name'))]"
              ]
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "acr_login_server": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', variables('_acr_name')), '2023-01-01-preview').loginServer]"
            },
            "acr_name": {
              "type": "string",
              "value": "[variables('_acr_name')]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
      ],
      "metadata": {
        "description": "Create Container Registry"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}_{1}_{2}_container_app', parameters('container_instance_params').name_prefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "container_instance_params": {
            "value": "[parameters('container_instance_params')]"
          },
          "deploymentParams": {
            "value": "[parameters('deploymentParams')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "uami_name_akane": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.uami_name_akane.value]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.logAnalyticsPayGWorkspaceName.value]"
          },
          "acr_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_container_registry', parameters('container_instance_params').name_prefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.acr_name.value]"
          },
          "saName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.saName.value]"
          },
          "blobContainerName": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_blob', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.blobContainerName.value]"
          },
          "cosmos_db_accnt_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_cosmos_db', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.cosmos_db_accnt_name.value]"
          },
          "cosmos_db_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_cosmos_db', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.cosmos_db_name.value]"
          },
          "cosmos_db_container_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_cosmos_db', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.cosmos_db_container_name.value]"
          },
          "svc_bus_ns_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_Svc_Bus', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.svc_bus_ns_name.value]"
          },
          "svc_bus_q_name": {
            "value": "[reference(resourceId('Microsoft.Resources/deployments', format('{0}_{1}_Svc_Bus', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness)), '2022-09-01').outputs.svc_bus_q_name.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.18.4.5664",
              "templateHash": "3088122707112207096"
            }
          },
          "parameters": {
            "module_metadata": {
              "type": "object",
              "defaultValue": {
                "module_last_updated": "2023-06-25",
                "owner": "miztiik@github"
              }
            },
            "deploymentParams": {
              "type": "object"
            },
            "tags": {
              "type": "object"
            },
            "uami_name_akane": {
              "type": "string"
            },
            "logAnalyticsWorkspaceName": {
              "type": "string"
            },
            "container_instance_params": {
              "type": "object"
            },
            "acr_name": {
              "type": "string"
            },
            "svc_bus_ns_name": {
              "type": "string"
            },
            "svc_bus_q_name": {
              "type": "string"
            },
            "saName": {
              "type": "string"
            },
            "blobContainerName": {
              "type": "string"
            },
            "cosmos_db_accnt_name": {
              "type": "string"
            },
            "cosmos_db_name": {
              "type": "string"
            },
            "cosmos_db_container_name": {
              "type": "string"
            }
          },
          "variables": {
            "_c_grp_name": "[replace(format('{0}-{1}-{2}-{3}', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('container_instance_params').name_prefix, parameters('deploymentParams').global_uniqueness), '_', '')]",
            "cosmosDbDataContributor_RoleDefinitionId": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleDefinitions', parameters('cosmos_db_accnt_name'), '00000000-0000-0000-0000-000000000002')]"
          },
          "resources": [
            {
              "type": "Microsoft.ContainerInstance/containerGroups",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}-producer', variables('_c_grp_name'))]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "zones": [
                "1"
              ],
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')))]": {}
                }
              },
              "properties": {
                "containers": [
                  {
                    "name": "miztiik-event-producer",
                    "properties": {
                      "environmentVariables": [
                        {
                          "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                          "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
                        },
                        {
                          "name": "SVC_BUS_FQDN",
                          "value": "[format('{0}.servicebus.windows.net', parameters('svc_bus_ns_name'))]"
                        },
                        {
                          "name": "SVC_BUS_Q_NAME",
                          "value": "[parameters('svc_bus_q_name')]"
                        },
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), '2023-01-31').clientId]"
                        },
                        {
                          "name": "TOT_MSGS_TO_PRODUCE",
                          "value": "15"
                        }
                      ],
                      "image": "[format('{0}.azurecr.io/miztiik/event-processor-for-svc-bus-q:latest', toLower(parameters('acr_name')))]",
                      "ports": [
                        {
                          "port": 80,
                          "protocol": "TCP"
                        }
                      ],
                      "resources": {
                        "requests": {
                          "cpu": 1,
                          "memoryInGB": 2
                        }
                      }
                    }
                  }
                ],
                "osType": "Linux",
                "restartPolicy": "Always",
                "imageRegistryCredentials": [
                  {
                    "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').username]",
                    "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').loginServer]",
                    "password": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').passwords[0].value]"
                  }
                ],
                "diagnostics": {
                  "logAnalytics": {
                    "logType": "ContainerInsights",
                    "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                    "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
                  }
                },
                "ipAddress": {
                  "type": "Public",
                  "dnsNameLabel": "[variables('_c_grp_name')]",
                  "ports": [
                    {
                      "port": 80,
                      "protocol": "TCP"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.ContainerInstance/containerGroups",
              "apiVersion": "2021-09-01",
              "name": "[format('{0}-consumer', variables('_c_grp_name'))]",
              "location": "[parameters('deploymentParams').location]",
              "tags": "[parameters('tags')]",
              "zones": [
                "1"
              ],
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')))]": {}
                }
              },
              "properties": {
                "containers": [
                  {
                    "name": "miztiik-event-consumer",
                    "properties": {
                      "environmentVariables": [
                        {
                          "name": "AZURE_CLIENT_ID",
                          "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), '2023-01-31').clientId]"
                        },
                        {
                          "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
                          "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
                        },
                        {
                          "name": "SVC_BUS_FQDN",
                          "value": "[format('{0}.servicebus.windows.net', parameters('svc_bus_ns_name'))]"
                        },
                        {
                          "name": "SVC_BUS_Q_NAME",
                          "value": "[parameters('svc_bus_q_name')]"
                        },
                        {
                          "name": "SA_NAME",
                          "value": "[parameters('saName')]"
                        },
                        {
                          "name": "BLOB_SVC_ACCOUNT_URL",
                          "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('saName')), '2021-06-01').primaryEndpoints.blob]"
                        },
                        {
                          "name": "BLOB_NAME",
                          "value": "[parameters('blobContainerName')]"
                        },
                        {
                          "name": "COSMOS_DB_URL",
                          "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmos_db_accnt_name')), '2022-08-15').documentEndpoint]"
                        },
                        {
                          "name": "COSMOS_DB_NAME",
                          "value": "[parameters('cosmos_db_name')]"
                        },
                        {
                          "name": "COSMOS_DB_CONTAINER_NAME",
                          "value": "[parameters('cosmos_db_container_name')]"
                        },
                        {
                          "name": "MAX_MSGS_TO_PROCESS",
                          "value": "10"
                        }
                      ],
                      "image": "[format('{0}.azurecr.io/miztiik/event-processor-for-svc-bus-q:latest', toLower(parameters('acr_name')))]",
                      "ports": [
                        {
                          "port": 80,
                          "protocol": "TCP"
                        }
                      ],
                      "resources": {
                        "requests": {
                          "cpu": 1,
                          "memoryInGB": 2
                        }
                      }
                    }
                  }
                ],
                "osType": "Linux",
                "restartPolicy": "Always",
                "imageRegistryCredentials": [
                  {
                    "username": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').username]",
                    "server": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').loginServer]",
                    "password": "[listCredentials(resourceId('Microsoft.ContainerRegistry/registries', parameters('acr_name')), '2022-02-01-preview').passwords[0].value]"
                  }
                ],
                "diagnostics": {
                  "logAnalytics": {
                    "logType": "ContainerInsights",
                    "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]",
                    "workspaceKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
                  }
                },
                "ipAddress": {
                  "type": "Public",
                  "dnsNameLabel": "[variables('_c_grp_name')]",
                  "ports": [
                    {
                      "port": 80,
                      "protocol": "TCP"
                    }
                  ]
                }
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2021-04-15",
              "name": "[format('{0}/{1}', parameters('cosmos_db_accnt_name'), guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmos_db_accnt_name')), variables('cosmosDbDataContributor_RoleDefinitionId')))]",
              "properties": {
                "roleDefinitionId": "[variables('cosmosDbDataContributor_RoleDefinitionId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmos_db_accnt_name'))]",
                "principalId": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('uami_name_akane')), '2023-01-31').principalId]"
              }
            }
          ],
          "outputs": {
            "module_metadata": {
              "type": "object",
              "value": "[parameters('module_metadata')]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', format('{0}-producer', variables('_c_grp_name'))), '2021-09-01').ipAddress.fqdn]"
            },
            "consumer_fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerInstance/containerGroups', format('{0}-consumer', variables('_c_grp_name'))), '2021-09-01').ipAddress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.Resources/deployments', format('perms_provider_to_uami_{0}', parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_blob', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_container_registry', parameters('container_instance_params').name_prefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_cosmos_db', parameters('cosmosDbParams').cosmosDbNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_la', parameters('logAnalyticsWorkspaceParams').workspaceName, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_sa', parameters('storageAccountParams').storageAccountNamePrefix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_Svc_Bus', parameters('svc_bus_params').name_prefix, parameters('deploymentParams').global_uniqueness))]",
        "[resourceId('Microsoft.Resources/deployments', format('{0}_{1}_{2}_uami', parameters('deploymentParams').enterprise_name_suffix, parameters('deploymentParams').loc_short_code, parameters('deploymentParams').global_uniqueness))]"
      ],
      "metadata": {
        "description": "Create Container Instance"
      }
    }
  ]
}